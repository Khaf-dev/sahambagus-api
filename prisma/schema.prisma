// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum AnalysisType {
  TECHNICAL
  FUNDAMENTAL
  SENTIMENT
  MARKET_UPDATE
}

enum ContentStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

enum UserRole {
  ADMIN
  EDITOR
}

// ============================================
// NEWS MODULE
// ============================================

model News {
  id       String  @id @default(dbgenerated("uuid_generate_v4()"))
  slug     String  @unique @db.VarChar(255)
  title    String  @db.VarChar(500)
  subtitle String? @db.VarChar(1000)
  content  String  @db.Text
  excerpt  String? @db.VarChar(500)

  categoryId String?       @map("category_id")
  // Editorial Workflow
  status     ContentStatus @default(DRAFT)

  // Media
  isFeatured       Boolean @default(false) @map("is_featured")
  featuredImageUrl String? @map("featured_image_url") @db.VarChar(500)
  featuredImageAlt String? @map("featured_image_alt") @db.VarChar(255)

  // SEO
  metaTitle       String? @map("meta_title") @db.VarChar(255)
  metaDescription String? @map("meta_description") @db.VarChar(500)
  metaKeywords    String? @map("meta_keywords") @db.VarChar(500)

  // Author tracking
  authorId String? @map("author_id")
  editorId String? @map("editor_id")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  publishedAt DateTime? @map("published_at") @db.Timestamptz(6)
  archivedAt  DateTime? @map("archived_at") @db.Timestamptz(6)

  // Soft delete
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // View counter
  viewCount Int @default(0) @map("view_count")

  // Relations
  //  author User? @relation("NewsAuthor", fields: [authorId], references: [id], onDelete: SetNull)
  //  editor User? @relation("NewsEditor", fields: [editorId], references: [id], onDelete: SetNull)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags     NewsTag[]

  @@index([slug], name: "idx_news_slug")
  @@index([status], name: "idx_news_status")
  @@index([publishedAt], name: "idx_news_published_at")
  @@index([status, publishedAt], name: "idx_news_status_published")
  @@index([deletedAt], name: "idx_news_deleted_at")
  @@index([isFeatured, status], name: "idx_news_featured_status")
  @@index([categoryId], name: "idx_news_category_id")
  @@map("news")
}

// ============================================
// News Tags
// ============================================

model NewsTag {
  id     String @id @default(dbgenerated("uuid_generate_v4()"))
  newsId String @map("news_id")
  tagId  String @map("tag_id")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  news News @relation(fields: [newsId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([newsId, tagId], name: "unique_news_tag")
  @@index([newsId], name: "idx_news_tag_news_id")
  @@index([tagId], name: "idx_news_tag_tag_id")
  @@map("news_tags")
}

// ============================================
// Category
// ============================================

model Category {
  id          String  @id @default(dbgenerated("uuid_generate_v4()"))
  name        String  @unique @db.VarChar(100)
  slug        String  @unique @db.VarChar(100)
  description String? @db.VarChar(500)
  color       String? @db.VarChar(7) // Hex color
  icon        String? @db.VarChar(50) // Icon name for frontend

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  news     News[]
  analysis Analysis[] // untuk nanti

  @@index([slug], name: "idx_category_slug")
  @@map("categories")
}

// ============================================
// ANALYSIS MODULE
// ============================================

model Analysis {
  id       String  @id @default(dbgenerated("uuid_generate_v4()"))
  slug     String  @unique @db.VarChar(255)
  title    String  @db.VarChar(500)
  subtitle String? @db.VarChar(1000)
  content  String  @db.Text
  excerpt  String? @db.VarChar(500)

  // Analysis-specific fields
  stockTicker  String       @map("stock_ticker") @db.VarChar(20)
  analysisType AnalysisType @map("analysis_type")
  targetPrice  Decimal?     @map("target_price") @db.Decimal(15, 2)

  // Media
  isFeatured       Boolean @default(false) @map("is_featured")
  featuredImageUrl String? @map("featured_image_url") @db.VarChar(500)
  featuredImageAlt String? @map("featured_image_alt") @db.VarChar(255)

  // Categorization
  categoryId String? @map("category_id")

  // SEO
  metaTitle       String? @map("meta_title") @db.VarChar(255)
  metaDescription String? @map("meta_description") @db.VarChar(500)
  metaKeywords    String? @map("meta_keywords") @db.VarChar(500)

  // Editorial Workflow
  status ContentStatus @default(DRAFT)

  // Author tracking
  authorId String? @map("author_id")
  editorId String? @map("editor_id")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  publishedAt DateTime? @map("published_at") @db.Timestamptz(6)
  archivedAt  DateTime? @map("archived_at") @db.Timestamptz(6)

  // Soft delete
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // View counter
  viewCount Int @default(0) @map("view_count")

  // Relations
  //  author User? @relation("AnalysisAuthor", fields: [authorId], references: [id], onDelete: SetNull)
  //  editor User? @relation("AnalysisEditor", fields: [editorId], references: [id], onDelete: SetNull)
  analysisTags AnalysisTag[]
  category     Category?     @relation(fields: [categoryId], references: [id])

  @@index([slug], name: "idx_analysis_slug")
  @@index([status], name: "idx_analysis_status")
  @@index([publishedAt], name: "idx_analysis_published_at")
  @@index([status, publishedAt], name: "idx_analysis_status_published")
  @@index([deletedAt], name: "idx_analysis_deleted_at")
  @@index([isFeatured, status], name: "idx_analysis_featured_status")
  @@index([stockTicker], name: "idx_analysis_stock_ticker")
  @@index([analysisType], name: "idx_analysis_type")
  @@index([categoryId], name: "idx_analysis_category_id")
  @@map("analysis")
}

// ============================================
// Tag MODEL 
// ============================================

model Tag {
  id   String @id @default(dbgenerated("uuid_generate_v4()"))
  name String @unique @db.VarChar(50)
  slug String @unique @db.VarChar(50)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // RElations
  newsItems     NewsTag[]
  analysisItems AnalysisTag[]

  @@index([slug], name: "idx_tag_slug")
  @@map("tags")
}

// ============================================
// AnalysisTag Model
// ============================================

model AnalysisTag {
  id         String @id @default(dbgenerated("uuid_generate_v4()"))
  analysisId String @map("analysis_id")
  tagId      String @map("tag_id")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  analysis Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([analysisId, tagId], name: "unique_analysis_tag")
  @@index([analysisId], name: "idx_analysis_tag_analysis_id")
  @@index([tagId], name: "idx_analysis_tag_tag_id")
  @@map("analysis_tags")
}

// ============================================
// AUTH MODULE
// ============================================

model User {
  id           String   @id @default(dbgenerated("uuid_generate_v4()"))
  email        String   @unique @db.VarChar(255)
  name         String   @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  role         UserRole @default(EDITOR)

  // Account status
  isActive Boolean @default(true) @map("is_active")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastLoginAt DateTime? @map("last_login_at") @db.Timestamptz(6)

  // Soft delete
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  //  newsAsAuthor     News[]     @relation("NewsAuthor")
  //  newsAsEditor     News[]     @relation("NewsEditor")
  //  analysisAsAuthor Analysis[] @relation("AnalysisAuthor")
  //  analysisAsEditor Analysis[] @relation("AnalysisEditor")

  @@index([email], name: "idx_user_email")
  @@index([role], name: "idx_user_role")
  @@index([deletedAt], name: "idx_user_deleted_at")
  @@map("users")
}

// ============================================
// REDIRECT MAPPING
// ============================================

model RedirectMapping {
  id          String @id @default(dbgenerated("uuid_generate_v4()"))
  oldSlug     String @unique @map("old_slug") @db.VarChar(255)
  newSlug     String @map("new_slug") @db.VarChar(255)
  contentType String @map("content_type") @db.VarChar(50)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([oldSlug], name: "idx_redirect_old_slug")
  @@index([contentType], name: "idx_redirect_content_type")
  @@map("redirect_mappings")
}
